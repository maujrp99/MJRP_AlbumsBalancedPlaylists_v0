<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Curadoria Híbrida</title>
    <style>
        /* Scrollbar */
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Spinner de Loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #1DB954;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Classe de estado de loading */
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Modal (Passo 1) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background-color: #181818;
            border: 1px solid #282828;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-body {
            overflow-y: auto;
        }

        /* Fim Modal */
    </style>
</head>

<body class="h-full antialiased">

    <!-- Container principal do App -->
    <div id="app-container">

        <!-- Header Fixo -->
        <header class="p-4 shadow-lg">
            <div class="container mx-auto flex items-center justify-between max-w-7xl">
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-spotify-green" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 19V6l12-3v13M9 19c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2zm12-3c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2z" />
                    </svg>
                    <h1 class="text-xl font-bold text-white tracking-tight">Curadoria Híbrida</h1>
                </div>

                <!-- Botões de Ação -->
                <div class="flex items-center space-x-3">
                    <!-- (Passo 1) Botão Carregar Dados -->
                    <button id="loadDataBtn"
                        class="bg-gray-700 text-white px-4 py-2 rounded-full font-semibold text-sm hover:bg-gray-600 transition-colors">
                        Carregar Dados
                    </button>
                    <!-- Botão de "Toggle View" -->
                    <button id="toggleViewBtn"
                        class="bg-gray-700 text-white px-4 py-2 rounded-full font-semibold text-sm hover:bg-gray-600 transition-colors">
                        Ver Playlists
                    </button>
                    <!-- Botão Salvar -->
                    <button id="saveBtn"
                        class="bg-spotify-green text-black px-5 py-2 rounded-full font-bold text-sm hover:bg-green-400 transition-colors flex items-center space-x-2">
                        <svg id="save-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="save-text">Salvar</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal (Álbuns ou Playlists) -->
        <main id="main-content" class="container mx-auto max-w-7xl p-4 md:p-6">

            <!-- Tela de Loading Inicial -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center p-16">
                <div class="spinner"></div>
                <p class="mt-4 text-spotify-lightgray">Carregando dados do Firestore...</p>
            </div>

            <!-- View dos Álbuns (Default) -->
            <section id="albums-view" class="hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Álbuns (Origem)</h2>

                <!-- Resumo de Verificação (Álbuns) -->
                <div id="albums-summary" class="bg-spotify-gray p-4 rounded-lg mb-6 shadow-md">
                    <!-- O conteúdo será injetado pelo JS -->
                </div>

                <!-- Botão Gerar Playlists -->
                <div class="text-center my-6">
                    <button id="generateBtn"
                        class="bg-spotify-green text-black px-8 py-3 rounded-full font-bold text-lg hover:bg-green-400 transition-colors shadow-lg">
                        Gerar Playlists (Algoritmo Híbrido)
                    </button>
                </div>

                <!-- Grid de Álbuns -->
                <div id="albums-grid" class="card-grid">
                    <!-- Cards de Álbuns serão injetados pelo JS -->
                </div>
            </section>

            <!-- View das Playlists -->
            <section id="playlists-view" class="hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Playlists Geradas</h2>

                <!-- Resumo de Verificação (Playlists) -->
                <div id="playlists-summary" class="bg-spotify-gray p-4 rounded-lg mb-6 shadow-md">
                    <!-- O conteúdo será injetado pelo JS -->
                </div>

                <!-- Grid de Playlists -->
                <div id="playlists-grid" class="card-grid">
                    <!-- Cards de Playlists serão injetados pelo JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- (Passo 1) Modal de Carregar Dados -->
    <div id="dataModal" class="modal hidden">
        <div class="modal-content rounded-lg shadow-xl">
            <!-- Header do Modal -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Buscar Álbuns (Texto)</h3>
                <!-- (Passo 2) Botão Fechar (X) -->
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Body do Modal (com o input) -->
            <div class="modal-body p-4">
                <p class="text-sm text-gray-400 mb-2">
                    Cole a lista de álbuns abaixo, um por linha. Exemplo: "Pink Floyd - Dark Side of the Moon".
                    A IA buscará os metadados (faixas, duração) automaticamente.
                </p>
                <!-- (Passo 1) Caixa de Texto -->
                <textarea id="jsonInput"
                    class="w-full h-64 bg-gray-900 border border-gray-700 rounded-md p-3 text-sm font-mono text-white focus:outline-none focus:ring-2 focus:ring-spotify-green"
                    placeholder="Artista - Álbum&#10;Artista - Álbum..." spellcheck="false"></textarea>
                <!-- (Passo 3) Mensagem de Erro -->
                <p id="jsonError" class="text-red-400 text-sm mt-2 font-medium"></p>
            </div>

            <!-- Footer do Modal (Botões) -->
            <div class="p-4 border-t border-gray-700 bg-gray-800 rounded-b-lg flex justify-end space-x-3">
                <!-- (Passo 2) Botão Cancelar -->
                <button id="cancelModalBtn"
                    class="bg-gray-600 text-white px-4 py-2 rounded-full font-semibold text-sm hover:bg-gray-500 transition-colors">
                    Cancelar
                </button>
                <!-- (Passo 3) Botão Processar -->
                <button id="processJsonBtn"
                    class="bg-spotify-green text-black px-4 py-2 rounded-full font-bold text-sm hover:bg-green-400 transition-colors">
                    Buscar Metadados e Salvar
                </button>
            </div>
        </div>
    </div>


    <!-- Biblioteca SortableJS (Drag-and-Drop) -->
    <!-- Movido para o final do Body e com 'defer' para garantir o carregamento antes do script do app -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js" defer></script>

    <!-- Firebase (Módulo) -->
    <!-- Firebase Config (Inline) -->
    <script>
        window.__firebase_config = {
            apiKey: "AIzaSyA8x-II628CK3qQmmfr-WJE13LXdu7nAxs",
            authDomain: "mjrp-playlist-generator.firebaseapp.com",
            projectId: "mjrp-playlist-generator",
            storageBucket: "mjrp-playlist-generator.firebasestorage.app",
            messagingSenderId: "540062660076",
            appId: "1:540062660076:web:f2cd9d6c24d9dd702ffcc9"
        };
        console.log("Inline config loaded:", window.__firebase_config);
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { fetchAlbumMetadata } from './js/api.js';
        import { curateAlbums } from './js/curation.js';

        const firebaseConfig = window.__firebase_config;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, auth, db;
        let userId;

        let albumsDocRef;
        let playlistsDocRef;

        let currentAlbums = [];
        let currentPlaylists = [];
        let isAlbumsView = true;
        let sortableInstances = [];
        let unsubscribeAlbums = null;
        let unsubscribePlaylists = null;

        // UI elements
        let mainContent, loadingSpinner, albumsView, playlistsView, albumsGrid, playlistsGrid;
        let toggleViewBtn, generateBtn, saveBtn, saveText, saveIcon;
        let albumsSummary, playlistsSummary;
        let loadDataBtn, dataModal, closeModalBtn, cancelModalBtn, processJsonBtn, jsonInput, jsonError;

        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function calculateTotalDuration(tracks) {
            return (tracks || []).reduce((s, x) => s + (x.duration || 0), 0);
        }

        async function processAndSaveJSON() {
            const originalBtnText = processJsonBtn.textContent;
            processJsonBtn.disabled = true;
            processJsonBtn.classList.add('opacity-50', 'cursor-not-allowed');
            jsonError.textContent = '';

            try {
                const lines = (jsonInput.value || '').split(/\n+/).map(l => l.trim()).filter(Boolean);
                if (lines.length === 0) throw new Error('Nenhuma linha válida fornecida.');

                const newAlbums = [];
                const errors = [];

                for (let i = 0; i < lines.length; i++) {
                    const query = lines[i];
                    processJsonBtn.textContent = `Buscando ${i + 1}/${lines.length}...`;
                    jsonError.textContent = `Processando: "${query}"...`;
                    try {
                        const albumData = await fetchAlbumMetadata(query);
                        if (albumData) newAlbums.push(albumData);
                        else errors.push(`Não encontrado: ${query}`);
                    } catch (err) {
                        console.error(`Erro ao buscar "${query}":`, err);
                        errors.push(`Erro em "${query}": ${err.message}`);
                    }
                }

                if (newAlbums.length === 0) throw new Error('Nenhum álbum foi encontrado.');

                await saveDataToFirestore(newAlbums, currentPlaylists);
                closeDataModal();

                if (errors.length > 0) alert(`Importação concluída com ${newAlbums.length} álbuns.\n\nFalhas:\n${errors.join('\n')}`);
            } catch (error) {
                console.error('Erro no processo:', error);
                jsonError.classList.remove('text-yellow-400');
                jsonError.classList.add('text-red-400');
                jsonError.textContent = `Erro: ${error.message}`;
            } finally {
                processJsonBtn.disabled = false;
                processJsonBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                processJsonBtn.textContent = 'Buscar Metadados e Salvar';
            }
        }

        function renderAlbumsView(albums) {
            albumsGrid.innerHTML = '';
            if (!albums || albums.length === 0) {
                albumsGrid.innerHTML = `<p class="text-spotify-lightgray col-span-full text-center">Nenhum álbum carregado. Clique em \"Carregar Dados\" para começar.</p>`;
                albumsSummary.innerHTML = `<p class="text-center text-spotify-lightgray">Nenhum dado de origem.</p>`;
                return;
            }

            let totalTracks = 0;
            let totalDuration = 0;

            albums.forEach(album => {
                if (!album) return;
                const albumTracks = album.tracks || [];
                const albumDuration = calculateTotalDuration(albumTracks);
                totalTracks += albumTracks.length;
                totalDuration += albumDuration;

                const albumCard = document.createElement('div');
                albumCard.className = 'bg-spotify-lightdark p-4 rounded-lg shadow-lg flex flex-col transition-shadow hover:shadow-xl';
                albumCard.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${album.cover || 'https://placehold.co/100x100/333/888?text=Capa'}" alt="Capa do ${album.title}" class="w-20 h-20 rounded-md mr-4 object-cover" onerror="this.src='https://placehold.co/100x100/333/888?text=Capa'">
                        <div>
                            <h3 class="text-xl font-bold text-white">${album.title || 'Título Desconhecido'}</h3>
                            <p class="text-sm text-spotify-lightgray">${album.artist || 'Artista Desconhecido'} (${album.year || '----'})</p>
                        </div>
                    </div>
                    <div class="border-t border-spotify-gray pt-2">
                        <div class="flex justify-between text-sm text-spotify-lightgray mb-2 px-2">
                            <span class="font-semibold">#</span>
                            <span class="flex-1 ml-4 font-semibold">Faixa</span>
                            <span class="font-semibold">Duração</span>
                        </div>
                        <ul class="space-y-1">
                            ${albumTracks.sort((a,b)=> (a.rank||99)-(b.rank||99)).map(track => `
                                <li class="flex justify-between items-center p-2 rounded-md hover:bg-spotify-gray">
                                    <span class="text-spotify-lightgray w-6 text-center">${track.rank || '-'}</span>
                                    <span class="flex-1 ml-2 text-white truncate" title="${track.title}">${track.title || 'Faixa Desconhecida'}</span>
                                    <span class="text-spotify-lightgray text-sm">${formatDuration(track.duration)}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="border-t border-spotify-gray mt-2 pt-2 text-right">
                        <span class="text-sm font-semibold text-spotify-lightgray">Total: ${albumTracks.length} faixas, ${formatDuration(albumDuration)}</span>
                    </div>
                `;
                albumsGrid.appendChild(albumCard);
            });

            albumsSummary.innerHTML = `
                <h3 class="text-lg font-semibold text-white mb-2">Resumo dos Álbuns (Origem)</h3>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-spotify-lightgray">Total de Álbuns:</p>
                        <p class="text-2xl font-bold text-white">${albums.length}</p>
                    </div>
                    <div>
                        <p class="text-sm text-spotify-lightgray">Total de Faixas:</p>
                        <p class="text-2xl font-bold text-white">${totalTracks}</p>
                    </div>
                    <div>
                        <p class="text-sm text-spotify-lightgray">Duração Total:</p>
                        <p class="text-2xl font-bold text-white">${formatDuration(totalDuration)}</p>
                    </div>
                </div>
            `;
        }

        function renderTrackItem(track) {
            const originAlbum = currentAlbums.find(a => a.tracks && a.tracks.some(t => t.id === track.id));
            const albumTitle = originAlbum ? originAlbum.title : 'N/A';
            return `
                <li class="track-item flex justify-between items-center p-2 rounded-md hover:bg-spotify-gray" data-track-id="${track.id}">
                    <div class="flex-1 truncate mr-2">
                        <p class="text-white truncate" title="${track.title}">${track.title || 'Faixa Desconhecida'}</p>
                        <p class="text-xs text-spotify-lightgray">Rank: ${track.rank || '-'}</p>
                    </div>
                    <span class="text-spotify-lightgray text-sm w-16 truncate text-center" title="${albumTitle}">${albumTitle}</span>
                    <span class="text-spotify-lightgray text-sm w-12 text-right">${formatDuration(track.duration)}</span>
                </li>
            `;
        }

        function renderPlaylistsView(playlists) {
            playlistsGrid.innerHTML = '';
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];

            if (!playlists || playlists.length === 0) {
                playlistsGrid.innerHTML = `<p class="text-spotify-lightgray col-span-full text-center">Nenhuma playlist gerada. Volte e clique em \"Gerar Playlists\".</p>`;
                playlistsSummary.innerHTML = `<p class="text-center text-spotify-lightgray">Nenhuma playlist para resumir.</p>`;
                return;
            }

            let totalTracks = 0;
            let totalDuration = 0;

            playlists.forEach(playlist => {
                if (!playlist) return;
                const playlistTracks = playlist.tracks || [];
                const playlistDuration = calculateTotalDuration(playlistTracks);
                totalTracks += playlistTracks.length;
                totalDuration += playlistDuration;

                const playlistCard = document.createElement('div');
                playlistCard.className = 'bg-spotify-lightdark p-4 rounded-lg shadow-lg flex flex-col';
                playlistCard.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-white">${playlist.title || 'Playlist Sem Título'}</h3>
                        <p class="text-sm text-spotify-lightgray">${playlist.subtitle || ' '}</p>
                    </div>
                    <div class="border-t border-spotify-gray pt-2 flex-1">
                        <div class="flex justify-between text-sm text-spotify-lightgray mb-2 px-2">
                            <span class="flex-1 font-semibold">Faixa (Rank)</span>
                            <span class="font-semibold">Álbum</span>
                            <span class="font-semibold">Duração</span>
                        </div>
                        <ul id="playlist-${playlist.id}" data-playlist-id="${playlist.id}" class="space-y-1 h-full min-h-[150px]">
                            ${playlistTracks.map(track => renderTrackItem(track)).join('')}
                        </ul>
                    </div>
                    <div class="border-t border-spotify-gray mt-2 pt-2 text-right">
                        <span class="text-sm font-semibold text-spotify-lightgray">Total: ${playlistTracks.length} faixas, ${formatDuration(playlistDuration)}</span>
                    </div>
                `;
                playlistsGrid.appendChild(playlistCard);
            });

            renderPlaylistsSummary(playlists, totalTracks, totalDuration);
            initSortable();
        }

        function renderPlaylistsSummary(playlists, totalTracks, totalDuration) {
            let originTotalTracks = 0;
            let originTotalDuration = 0;
            if (currentAlbums && currentAlbums.length > 0) {
                currentAlbums.forEach(album => {
                    if (album && album.tracks) {
                        originTotalTracks += album.tracks.length;
                        originTotalDuration += calculateTotalDuration(album.tracks);
                    }
                });
            }

            const tracksMatch = originTotalTracks === totalTracks;
            const durationMatch = originTotalDuration === totalDuration;
            const isOk = tracksMatch && durationMatch;

            let verificationHtml = '';
            if (isOk) verificationHtml = `<p class="text-2xl font-bold text-green-400">OK - Totais Batem!</p>`;
            else verificationHtml = `
                <p class="text-2xl font-bold text-red-400">ERRO - Totais Divergentes!</p>
                <div class="flex justify-around mt-2 text-sm">
                    <p class="text-gray-300">Origem: <span class="font-bold">${originTotalTracks} faixas</span> / <span class="font-bold">${formatDuration(originTotalDuration)}</span></p>
                    <p class="text-gray-300">Resultado: <span class="font-bold">${totalTracks} faixas</span> / <span class="font-bold">${formatDuration(totalDuration)}</span></p>
                </div>
            `;

            playlistsSummary.innerHTML = `
                <h3 class="text-lg font-semibold text-white mb-2">Resumo das Playlists (Resultado)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                    <div>
                        <p class="text-sm text-spotify-lightgray">Total de Playlists:</p>
                        <p class="text-2xl font-bold text-white">${playlists.length}</p>
                    </div>
                    <div>
                        <p class="text-sm text-spotify-lightgray">Total de Faixas:</p>
                        <p class="text-2xl font-bold text-white">${totalTracks}</p>
                    </div>
                    <div>
                        <p class="text-sm text-spotify-lightgray">Duração Total:</p>
                        <p class="text-2xl font-bold text-white">${formatDuration(totalDuration)}</p>
                    </div>
                </div>
                <div class="border-t border-spotify-gray pt-4 text-center">
                    <h4 class="text-md font-semibold text-white mb-1">Verificação de Integridade</h4>
                    ${verificationHtml}
                </div>
            `;
        }

        function toggleView() {
            isAlbumsView = !isAlbumsView;
            if (isAlbumsView) {
                albumsView.classList.remove('hidden');
                playlistsView.classList.add('hidden');
                toggleViewBtn.textContent = 'Ver Playlists';
            } else {
                albumsView.classList.add('hidden');
                playlistsView.classList.remove('hidden');
                toggleViewBtn.textContent = 'Ver Álbuns';
                renderPlaylistsView(currentPlaylists);
            }
        }

        function initSortable() {
            const lists = document.querySelectorAll('#playlists-grid ul');
            lists.forEach(list => {
                const sortable = new window.Sortable(list, {
                    group: 'playlists',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: handleDragEnd
                });
                sortableInstances.push(sortable);
            });
        }

        function handleDragEnd(evt) {
            const trackId = evt.item.dataset.trackId;
            const fromListId = evt.from.dataset.playlistId;
            const toListId = evt.to.dataset.playlistId;
            if (fromListId === toListId) updateTrackOrder(toListId, evt.newIndex, trackId);
            else moveTrackBetweenPlaylists(fromListId, toListId, evt.oldIndex, evt.newIndex, trackId);
            resetSaveButton && resetSaveButton();
        }

        function updateTrackOrder(playlistId, newIndex, trackId) {
            const playlist = currentPlaylists.find(p => p.id === playlistId);
            if (!playlist) return;
            const track = playlist.tracks.find(t => t.id === trackId);
            playlist.tracks = playlist.tracks.filter(t => t.id !== trackId);
            if (track) playlist.tracks.splice(newIndex, 0, track);
            renderPlaylistsView(currentPlaylists);
        }

        function moveTrackBetweenPlaylists(fromListId, toListId, oldIndex, newIndex, trackId) {
            const fromPlaylist = currentPlaylists.find(p => p.id === fromListId);
            const toPlaylist = currentPlaylists.find(p => p.id === toListId);
            if (!fromPlaylist || !toPlaylist) return;
            const trackIndex = fromPlaylist.tracks.findIndex(t => t.id === trackId);
            if (trackIndex > -1) {
                const [trackToMove] = fromPlaylist.tracks.splice(trackIndex, 1);
                toPlaylist.tracks.splice(newIndex, 0, trackToMove);
            }
            renderPlaylistsView(currentPlaylists);
        }

        async function runHybridCuration() {
            if (!currentAlbums || currentAlbums.length === 0) {
                alert('Nenhum álbum carregado para processar.');
                return;
            }
            try {
                const newPlaylists = curateAlbums(currentAlbums, { targetSeconds: 45 * 60 });
                currentPlaylists = newPlaylists;
                await saveDataToFirestore(currentAlbums, newPlaylists);
                if (isAlbumsView) toggleView(); else renderPlaylistsView(currentPlaylists);
            } catch (err) {
                console.error('Erro ao rodar curadoria:', err);
                alert('Erro ao processar curadoria: ' + (err && err.message ? err.message : String(err)));
            }
        }

        async function saveDataToFirestore(albums, playlists) {
            if (!userId) return console.error('Usuário não autenticado.');
            try {
                const albumsData = { data: JSON.parse(JSON.stringify(albums)) };
                const playlistsData = { data: JSON.parse(JSON.stringify(playlists)) };
                await setDoc(albumsDocRef, albumsData);
                await setDoc(playlistsDocRef, playlistsData);
            } catch (err) { console.error('Erro ao salvar:', err); }
        }

        function loadData() {
            albumsDocRef = doc(db, `artifacts/${appId}/users/${userId}/curator/albums`);
            playlistsDocRef = doc(db, `artifacts/${appId}/users/${userId}/curator/playlists`);

            if (unsubscribeAlbums) unsubscribeAlbums();
            unsubscribeAlbums = onSnapshot(albumsDocRef, (docSnap) => {
                loadingSpinner.classList.add('hidden');
                if (docSnap.exists()) currentAlbums = docSnap.data().data || [];
                else { currentAlbums = []; openDataModal(); }
                renderAlbumsView(currentAlbums);
            }, (error) => { console.error('Erro ao carregar álbuns:', error); alert('Erro ao carregar dados dos álbuns.'); });

            if (unsubscribePlaylists) unsubscribePlaylists();
            unsubscribePlaylists = onSnapshot(playlistsDocRef, (docSnap) => {
                if (docSnap.exists()) currentPlaylists = docSnap.data().data || [];
                else currentPlaylists = [];
                if (!isAlbumsView) renderPlaylistsView(currentPlaylists);
            }, (error) => { console.error('Erro ao carregar playlists:', error); alert('Erro ao carregar dados das playlists.'); });
        }

        async function initializeAppContainer() {
            setLogLevel('Debug');
            try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); }
            catch (error) { console.error('Erro ao inicializar Firebase:', error); mainContent.innerHTML = `<p class="text-red-400 text-center">Erro crítico ao conectar com o Firebase.</p>`; loadingSpinner.classList.add('hidden'); return; }

            mainContent = document.getElementById('main-content');
            loadingSpinner = document.getElementById('loading-spinner');
            albumsView = document.getElementById('albums-view');
            playlistsView = document.getElementById('playlists-view');
            albumsGrid = document.getElementById('albums-grid');
            playlistsGrid = document.getElementById('playlists-grid');
            toggleViewBtn = document.getElementById('toggleViewBtn');
            generateBtn = document.getElementById('generateBtn');
            saveBtn = document.getElementById('saveBtn');
            saveText = document.getElementById('save-text');
            saveIcon = document.getElementById('save-icon');
            albumsSummary = document.getElementById('albums-summary');
            playlistsSummary = document.getElementById('playlists-summary');

            loadDataBtn = document.getElementById('loadDataBtn');
            dataModal = document.getElementById('dataModal');
            closeModalBtn = document.getElementById('closeModalBtn');
            cancelModalBtn = document.getElementById('cancelModalBtn');
            processJsonBtn = document.getElementById('processJsonBtn');
            jsonInput = document.getElementById('jsonInput');
            jsonError = document.getElementById('jsonError');

            toggleViewBtn.addEventListener('click', toggleView);
            generateBtn.addEventListener('click', runHybridCuration);
            saveBtn.addEventListener('click', () => saveDataToFirestore(currentAlbums, currentPlaylists));
            loadDataBtn.addEventListener('click', openDataModal);
            closeModalBtn.addEventListener('click', closeDataModal);
            cancelModalBtn.addEventListener('click', closeDataModal);
            processJsonBtn.addEventListener('click', processAndSaveJSON);

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error('Erro na autenticação:', error);
                loadingSpinner.classList.add('hidden');
                mainContent.innerHTML = `<p class="text-red-400 text-center">Erro de autenticação. O app não pode carregar.</p>`;
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) { userId = user.uid; albumsView.classList.remove('hidden'); loadData(); }
                else { userId = null; if (unsubscribeAlbums) unsubscribeAlbums(); if (unsubscribePlaylists) unsubscribePlaylists(); }
            });
        }

        function openDataModal() { if (dataModal) dataModal.classList.remove('hidden'); }
        function closeDataModal() { if (dataModal) dataModal.classList.add('hidden'); }

        function robustInit() {
            let attempts = 0; const maxAttempts = 100;
            const interval = setInterval(() => {
                attempts++;
                if (typeof window.Sortable !== 'undefined') { clearInterval(interval); initializeAppContainer(); }
                else if (attempts > maxAttempts) { clearInterval(interval); loadingSpinner && loadingSpinner.classList.add('hidden'); mainContent && (mainContent.innerHTML = `<p class="text-red-400 text-center">Erro crítico: Sortable.js falhou ao carregar.</p>`); }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => { robustInit(); });

    </script>

</body>

</html>