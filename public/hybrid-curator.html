<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Curadoria Híbrida</title>
    <style>
        /* Scrollbar */
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Spinner de Loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #1DB954;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    <script src="./config.js"></script>
    <script type="module" src="./js/app.js"></script>

            if (unsubscribeAlbums) unsubscribeAlbums();
            unsubscribeAlbums = onSnapshot(albumsDocRef, (docSnap) => {
                loadingSpinner.classList.add('hidden');
                if (docSnap.exists()) currentAlbums = docSnap.data().data || [];
                else { currentAlbums = []; openDataModal(); }
                renderAlbumsView(currentAlbums);
            }, (error) => { console.error('Erro ao carregar álbuns:', error); alert('Erro ao carregar dados dos álbuns.'); });

            if (unsubscribePlaylists) unsubscribePlaylists();
            unsubscribePlaylists = onSnapshot(playlistsDocRef, (docSnap) => {
                if (docSnap.exists()) currentPlaylists = docSnap.data().data || [];
                else currentPlaylists = [];
                if (!isAlbumsView) renderPlaylistsView(currentPlaylists);
            }, (error) => { console.error('Erro ao carregar playlists:', error); alert('Erro ao carregar dados das playlists.'); });
        }

        async function initializeAppContainer() {
            setLogLevel('Debug');
            try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); }
            catch (error) { console.error('Erro ao inicializar Firebase:', error); mainContent.innerHTML = `<p class="text-red-400 text-center">Erro crítico ao conectar com o Firebase.</p>`; loadingSpinner.classList.add('hidden'); return; }

            mainContent = document.getElementById('main-content');
            loadingSpinner = document.getElementById('loading-spinner');
            albumsView = document.getElementById('albums-view');
            playlistsView = document.getElementById('playlists-view');
            albumsGrid = document.getElementById('albums-grid');
            playlistsGrid = document.getElementById('playlists-grid');
            toggleViewBtn = document.getElementById('toggleViewBtn');
            generateBtn = document.getElementById('generateBtn');
            saveBtn = document.getElementById('saveBtn');
            saveText = document.getElementById('save-text');
            saveIcon = document.getElementById('save-icon');
            albumsSummary = document.getElementById('albums-summary');
            playlistsSummary = document.getElementById('playlists-summary');

            loadDataBtn = document.getElementById('loadDataBtn');
            dataModal = document.getElementById('dataModal');
            closeModalBtn = document.getElementById('closeModalBtn');
            cancelModalBtn = document.getElementById('cancelModalBtn');
            processJsonBtn = document.getElementById('processJsonBtn');
            jsonInput = document.getElementById('jsonInput');
            jsonError = document.getElementById('jsonError');

            toggleViewBtn.addEventListener('click', toggleView);
            generateBtn.addEventListener('click', runHybridCuration);
            saveBtn.addEventListener('click', () => saveDataToFirestore(currentAlbums, currentPlaylists));
            loadDataBtn.addEventListener('click', openDataModal);
            closeModalBtn.addEventListener('click', closeDataModal);
            cancelModalBtn.addEventListener('click', closeDataModal);
            processJsonBtn.addEventListener('click', processAndSaveJSON);

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } catch (error) {
                console.error('Erro na autenticação:', error);
                loadingSpinner.classList.add('hidden');
                mainContent.innerHTML = `<p class="text-red-400 text-center">Erro de autenticação. O app não pode carregar.</p>`;
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) { userId = user.uid; albumsView.classList.remove('hidden'); loadData(); }
                else { userId = null; if (unsubscribeAlbums) unsubscribeAlbums(); if (unsubscribePlaylists) unsubscribePlaylists(); }
            });
        }

        function openDataModal() { if (dataModal) dataModal.classList.remove('hidden'); }
        function closeDataModal() { if (dataModal) dataModal.classList.add('hidden'); }

        function robustInit() {
            let attempts = 0; const maxAttempts = 100;
            const interval = setInterval(() => {
                attempts++;
                if (typeof window.Sortable !== 'undefined') { clearInterval(interval); initializeAppContainer(); }
                else if (attempts > maxAttempts) { clearInterval(interval); loadingSpinner && loadingSpinner.classList.add('hidden'); mainContent && (mainContent.innerHTML = `<p class="text-red-400 text-center">Erro crítico: Sortable.js falhou ao carregar.</p>`); }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => { robustInit(); });

    </script>

</body>

</html>