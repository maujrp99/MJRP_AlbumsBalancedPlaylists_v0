# v2.0 Deployment - MudanÃ§as e Impacto

**TL;DR**: âœ… **Backend sem mudanÃ§as, Frontend ganha apenas 1 build step**

> [!IMPORTANT]
> **Status (2025-12-09)**: `firebase.json` atualizado para `"public": "dist"` conforme especificado abaixo.

---

## ComparaÃ§Ã£o: v1.6.1 vs. v2.0

### Backend (Cloud Run)

#### âŒ O que NÃƒO muda

**Backend continua 100% igual**:
- âœ… Mesmo `server/Dockerfile`
- âœ… Mesmo `scripts/deploy-backend.sh`
- âœ… Mesmas variÃ¡veis de ambiente
- âœ… Mesmo processo de deploy

**Por quÃª?**  
Vite Ã© **sÃ³ para frontend**. Backend Node.js/Express continua exatamente como estÃ¡.

```bash
# Deploy backend v2.0 (IDÃŠNTICO ao v1.6.1)
./scripts/deploy-backend.sh

# Nenhuma mudanÃ§a necessÃ¡ria! ğŸ‰
```

---

### Frontend (Firebase Hosting)

#### ğŸ”„ O que MUDA

**Setup atual (v1.6.1)**:
```bash
# firebase.json
{
  "hosting": {
    "public": "public",  # Serve arquivos direto
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
  }
}

# Deploy
firebase deploy --only hosting
```

**Setup novo (v2.0)**:
```bash
# firebase.json (ATUALIZADO)
{
  "hosting": {
    "public": "dist",  # â† MUDANÃ‡A: serve build output
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"  # â† SPA routing
      }
    ]
  }
}

# Deploy (COM BUILD)
npm run build           # â† NOVO STEP
firebase deploy --only hosting
```

**Resumo da mudanÃ§a**:
1. â• Adicionar `npm run build` antes do deploy
2. ğŸ”„ Mudar `"public": "public"` â†’ `"public": "dist"`
3. â• Adicionar `rewrites` para SPA routing

**Isso Ã© tudo!** 

---

## Deploy Scripts Atualizados

### v1.6.1 (Atual)
```bash
# scripts/deploy-prod.sh (atual)
#!/bin/bash
firebase deploy --only hosting
```

### v2.0 (Novo)
```bash
# scripts/deploy-prod.sh (atualizado - APENAS 1 LINHA NOVA)
#!/bin/bash

# Build frontend
npm run build  # â† ÃšNICA LINHA NOVA

# Deploy to Firebase Hosting
firebase deploy --only hosting
```

**DiferenÃ§a**: Literalmente 1 linha (`npm run build`)

---

## VariÃ¡veis de Ambiente

### Backend (Cloud Run)

#### âŒ Sem mudanÃ§as

```bash
# v1.6.1 (atual)
AI_API_KEY=xxx
ALLOWED_ORIGIN=https://mjrp-playlist-generator.web.app
NODE_ENV=production
AI_ENDPOINT=...
AI_MODEL=...

# v2.0 (IDÃŠNTICO)
AI_API_KEY=xxx
ALLOWED_ORIGIN=https://mjrp-playlist-generator.web.app
NODE_ENV=production
AI_ENDPOINT=...
AI_MODEL=...
```

**Nenhuma variÃ¡vel nova necessÃ¡ria!**

---

### Frontend (Firebase Hosting)

#### âŒ Sem mudanÃ§as

```javascript
// public/config.js (v1.6.1 e v2.0 - IDÃŠNTICO)
const firebaseConfig = {
  apiKey: "xxx",
  authDomain: "mjrp-playlist-generator.firebaseapp.com",
  projectId: "mjrp-playlist-generator",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
}
```

**Config continua hard-coded no arquivo (como antes)**

**Por quÃª nÃ£o usar .env?**
- Frontend Ã© pÃºblico (build estÃ¡tico)
- Firebase config nÃ£o Ã© secreto (safe expor)
- Vite suporta `.env`, mas nÃ£o Ã© necessÃ¡rio aqui

---

## CI/CD (GitHub Actions)

### Workflow Atual (.github/workflows/ci-firebase.yml)

#### O que precisa mudar:

```diff
# .github/workflows/ci-firebase.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # Backend (SEM MUDANÃ‡AS)
      - name: Install backend deps
        run: cd server && npm ci
      - name: Test backend
        run: cd server && npm test
      
+     # Frontend (NOVO BUILD STEP)
+     - name: Install frontend deps
+       run: npm ci
+     - name: Build frontend
+       run: npm run build
      
      # Deploy (SEM MUDANÃ‡AS)
      - name: Deploy to Firebase
        run: firebase deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
```

**MudanÃ§as**:
1. â• `npm ci` (instalar Vite)
2. â• `npm run build` (build frontend)

**Secrets**: ZERO novos secrets necessÃ¡rios

---

## ConfiguraÃ§Ãµes no Google Cloud Console

### Cloud Run (Backend)

#### âŒ ZERO mudanÃ§as

- Service name: `mjrp-proxy` (mesmo)
- Region: `southamerica-east1` (mesmo)
- Container port: `3000` (mesmo)
- Environment variables: (mesmas)
- IAM: (mesmo)
- CPU/Memory: (mesmo)

**Nenhuma configuraÃ§Ã£o nova!**

---

### Firebase Hosting (Frontend)

#### ğŸ”„ MudanÃ§as mÃ­nimas

**No console Firebase** (apenas 1 vez):

Nenhuma configuraÃ§Ã£o manual necessÃ¡ria! `firebase.json` define tudo.

**Opcionalmente** (se quiser):
- Performance Monitoring: Continua funcionando
- Analytics: Continua funcionando
- Hosting headers: Pode adicionar cache headers para `/dist/assets/*`

---

## MigraÃ§Ã£o Passo a Passo

### Fase 1: Desenvolvimento (feature branch)

```bash
# JÃ¡ em feature/v2.0-foundation
npm install  # Instala Vite
npm run dev  # Testa localmente

# Backend continua rodando separado
cd server && npm start
```

**Impacto**: ZERO - SÃ³ no seu computador

---

### Fase 2: Staging/Preview

```bash
# Build local
npm run build

# Preview local
npm run preview
# OU
firebase serve --only hosting

# Testa se funciona
```

**Impacto**: ZERO - SÃ³ preview local

---

### Fase 3: Deploy ProduÃ§Ã£o

```bash
# 1. Atualizar firebase.json (1x apenas)
# 2. Atualizar scripts/deploy-prod.sh (adicionar npm run build)
# 3. Deploy
./scripts/deploy-prod.sh
```

**Impacto**: 
- âœ… Firebase Hosting continua servindo
- âœ… URL continua a mesma
- âœ… Backend nÃ£o afetado
- âœ… Rollback fÃ¡cil (reverter deploy)

---

## Rollback Plan

Se v2.0 quebrar algo:

### OpÃ§Ã£o 1: Rollback Firebase Hosting (30 segundos)

```bash
# Firebase Hosting guarda histÃ³rico de deploys
firebase hosting:channel:deploy previous

# OU no console Firebase:
# Hosting â†’ Release History â†’ "Rollback to this version"
```

**Tempo**: ~30 segundos  
**Impacto**: ZERO downtime

---

### OpÃ§Ã£o 2: Rollback Git (2 minutos)

```bash
# Volta para tag v1.6working-in-prod
git checkout v1.6working-in-prod

# Rebuild e deploy
firebase deploy --only hosting
```

**Tempo**: ~2 minutos  
**Impacto**: MÃ­nimo

---

## ComparaÃ§Ã£o: Complexidade de Deploy

### Webpack/CRA (se vocÃª escolhesse)

```bash
# Muitas configs:
- webpack.config.js (200+ linhas)
- .babelrc
- webpack-dev-server config
- Proxy config separado
- Env vars complexas
- Build pode quebrar com updates

# Deploy:
npm run build  # 1-5 minutos
```

### Vite (minha recomendaÃ§Ã£o)

```bash
# 1 arquivo config:
- vite.config.js (30 linhas)

# Deploy:
npm run build  # 10-30 segundos
```

**Vite Ã© mais simples!**

---

## Custos

### v1.6.1 (Atual)

- Firebase Hosting: Spark Plan (grÃ¡tis)
- Cloud Run: Pay-per-use (~$0-5/mÃªs)

### v2.0 (Novo)

- Firebase Hosting: Spark Plan (grÃ¡tis) â† **SEM MUDANÃ‡A**
- Cloud Run: Pay-per-use (~$0-5/mÃªs) â† **SEM MUDANÃ‡A**

**Build CI** (GitHub Actions):
- Adiciona ~30s por deploy
- Dentro do free tier (2000 min/mÃªs)

**Custo adicional**: $0

---

## Performance em ProduÃ§Ã£o

### Bundle Size

**v1.6.1** (sem bundler):
```
public/js/app.js          ~80 KB
public/js/curation.js     ~40 KB
public/js/api.js          ~10 KB
Sortable.js               ~90 KB
Total:                    ~220 KB
```

**v2.0** (com Vite):
```
dist/assets/index-abc123.js    ~150 KB (minified + gzipped)
dist/assets/vendor-xyz789.js   ~60 KB  (Sortable separado)
Total:                         ~210 KB
```

**Melhoria**: ~10 KB menor + code splitting

---

### Loading Speed

**v1.6.1**:
- 6 requests HTTP separados
- Sem cache hash (pode servir versÃ£o velha)
- Sem minificaÃ§Ã£o

**v2.0**:
- 2-3 requests (chunking inteligente)
- Hash no filename (cache perfeito)
- Minificado + tree-shaked

**Resultado**: ~20-30% mais rÃ¡pido

---

## Production Readiness Checklist

> [!IMPORTANT]
> **Ãšltima atualizaÃ§Ã£o**: 2025-12-10
> Este checklist foi criado baseado nos Issues #33 e #34 do DEBUG_LOG.md para evitar problemas recorrentes.

---

### ğŸ”§ Frontend Deploy Checklist

#### Pre-Build
- [ ] `firebase.json` estÃ¡ com `"public": "dist"` (NÃƒO `"public"`)
- [ ] Nenhuma dependÃªncia estÃ¡ em `external` no `vite.config.js` (axios, etc.)
- [ ] Sem CDN scripts desnecessÃ¡rios no `index.html`

#### Build
- [ ] `npm run build` executa sem erros
- [ ] Build output estÃ¡ em `dist/` (nÃ£o `public/`)
- [ ] Verificar que `dist/assets/main-*.js` existe e tem tamanho > 100KB

#### Static Files Copy
- [ ] `firebase-config.js` copiado para `dist/js/`
- [ ] `css/modals.css` copiado para `dist/css/`
- [ ] Outros assets (`favicon.ico`, `assets/`) copiados

> **Comando**: `./scripts/deploy-prod.sh` jÃ¡ faz tudo isso automaticamente.

#### Deploy
- [ ] `firebase deploy --only hosting` executa sem erros
- [ ] Console mostra "found X files in dist" (deve ser ~20-30 arquivos)

---

### ğŸ–¥ï¸ Backend Deploy Checklist

#### Pre-Deploy
- [ ] `shared/` folder contÃ©m todos os mÃ³dulos necessÃ¡rios:
  - `normalize.js` âœ…
  - `curation.js` âœ… (adicionado em 2025-12-10)
- [ ] `server/index.js` importa de `../shared/` (NÃƒO de `../public/`)
- [ ] Nenhum import de `../public/js/` no cÃ³digo do servidor

#### Deploy
- [ ] `./scripts/deploy-backend.sh` executa sem erros
- [ ] Cloud Run mostra nova revisÃ£o deployada

#### Container Structure
O container Docker deve ter:
```
/usr/src/app/      â†’ server code (index.js, lib/, etc.)
/usr/src/shared/   â†’ shared modules (normalize.js, curation.js)
```

**NÃƒO deve ter**: `/usr/src/public/` (frontend Ã© separado)

---

### âœ… Post-Deploy Validation

#### Frontend (https://mjrp-playlist-generator.web.app)
- [ ] App carrega sem erros no console
- [ ] Sem erros de "Failed to resolve module specifier"
- [ ] Firebase Auth inicializa corretamente
- [ ] Data Migration banner aparece (se aplicÃ¡vel)

#### Backend (/api endpoints)
- [ ] `/api/generate` (Load Albums) funciona
- [ ] `/api/playlists` (Generate Playlists) funciona - retorna 200
- [ ] Logs do Cloud Run sem erros 500

#### Smoke Tests
- [ ] Criar nova sÃ©rie
- [ ] Carregar Ã¡lbuns via Load Albums
- [ ] Gerar playlists
- [ ] Navegar entre views (Home, Albums, Playlists, Inventory)

---

### ğŸ”„ Rollback Plan

#### Frontend (Firebase Hosting)
```bash
# Via console ou CLI
firebase hosting:channel:deploy previous

# Ou no console Firebase:
# Hosting â†’ Release History â†’ "Rollback to this version"
```

#### Backend (Cloud Run)
```bash
# Listar revisÃµes
gcloud run revisions list --service=mjrp-proxy --region=southamerica-east1

# Rollback para revisÃ£o especÃ­fica
gcloud run services update-traffic mjrp-proxy \
  --to-revisions=mjrp-proxy-XXXXX=100 \
  --region=southamerica-east1
```

---

### ğŸ“‹ Known Issues Reference

| Issue | Sintoma | Causa | SoluÃ§Ã£o |
|-------|---------|-------|---------|
| #33 | `Failed to resolve module specifier "axios"` | `firebase.json` com `"public": "public"` | Mudar para `"public": "dist"` |
| #34 | `/api/playlists` retorna 500 | Import de `../public/js/curation.js` | Usar `../shared/curation.js` |

---

## Resposta Direta Ã s Suas Perguntas

### 1. "O que mudarÃ¡ nos deployments?"

**Backend**: Nada  
**Frontend**: Adicionar 1 step (`npm run build`)

---

### 2. "Conseguirei fazer normalmente via Cloud Run?"

**Sim!** Cloud Run nÃ£o muda nada. Deploy backend continua:
```bash
./scripts/deploy-backend.sh  # Exatamente como antes
```

---

### 3. "Terei que fazer muitas configuraÃ§Ãµes novas no console?"

**NÃ£o!** 
- Cloud Run: ZERO configs novas
- Firebase Hosting: ZERO configs no console (tudo via `firebase.json`)

---

### 4. "E variÃ¡veis de ambiente?"

**Backend**: Mesmas variÃ¡veis  
**Frontend**: Mesmas configuraÃ§Ãµes (hard-coded, nÃ£o secret)

**ZERO variÃ¡veis novas!**

---

## RecomendaÃ§Ã£o

### MigraÃ§Ã£o Segura

1. **Desenvolver em branch** âœ… (jÃ¡ estamos em `feature/v2.0-foundation`)
2. **Testar localmente** (`npm run build` + `npm run preview`)
3. **Deploy staging** (Firebase Hosting preview channel)
4. **Deploy produÃ§Ã£o** (quando aprovado)
5. **Rollback pronto** (Firebase guarda histÃ³rico)

### BenefÃ­cios vs. Complexidade

**BenefÃ­cios**:
- âš¡ Dev experience muito melhor (HMR)
- ğŸ“¦ Bundle otimizado (menor, mais rÃ¡pido)
- ğŸ¯ Code splitting automÃ¡tico
- ğŸ” Source maps para debug

**Complexidade adicionada**:
- â• 1 linha no script de deploy
- â• 1 arquivo de config (vite.config.js)
- â• npm install Vite (1x)

**Trade-off**: Vale muito a pena! ğŸš€

---

## ConclusÃ£o

**Deployment v2.0 Ã©**:
- âœ… **Simples**: Apenas 1 build step novo
- âœ… **Seguro**: Rollback fÃ¡cil
- âœ… **Sem custos**: $0 adicional
- âœ… **Sem configs**: ZERO variÃ¡veis novas
- âœ… **Backend inalterado**: Cloud Run continua igual

**VocÃª pode comeÃ§ar tranquilo!** 

Alguma dÃºvida especÃ­fica sobre deploy que ficou? Posso criar um script de deploy de teste para vocÃª ver antes de aprovar?
